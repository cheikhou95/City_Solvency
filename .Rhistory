`UAAL_reported`="OPEB",
`Pension.UL`="Pension"))
plot1 <- ggplot(total.reported, aes(x = reorder(city, value/1000), y = value/1000, fill = variable)) + geom_bar(stat = "identity") + scale_fill_manual(values=wes_palette(n=2, name="BottleRocket2")) +theme_classic() + coord_flip() + xlab("City") +
ylab("Unfunded Liability (in millions)") + ggtitle("Fig 1.a Unfunded Obligations \n (reported values in millions)") + theme(plot.title = element_text(hjust = 0.5)) +
labs(fill = "Debt Source")+ theme(legend.position = "none")
plot2 <- ggplot(total.reported, aes(x = reorder(city, log(value/1000)), y = log(value/1000), fill = variable)) + geom_bar(stat = "identity") + scale_fill_manual(values=wes_palette(n=2, name="BottleRocket2")) +theme_classic() + coord_flip() + xlab("City") +
ylab("Unfunded Liability (log scale)") + ggtitle("Fig 1.b Unfunded Obligations \n (reported values)") + theme(plot.title = element_text(hjust = 0.5)) +
labs(fill = "Debt Source")
plot1 <- ggplot(total.reported, aes(x = reorder(city, value/1000), y = value/1000, fill = variable)) + geom_bar(stat = "identity") + scale_fill_manual(values=wes_palette(n=2, name="BottleRocket2")) +theme_classic() + coord_flip() + xlab("City") +
ylab("Unfunded Liability (in millions)") + ggtitle("Fig 1.a Unfunded Obligations \n (reported values in millions)") + theme(plot.title = element_text(hjust = 0.5)) +
labs(fill = "Debt Source")+ theme(legend.position = "none")
plot2 <- ggplot(total.reported, aes(x = reorder(city, log(value/1000)), y = log(value/1000), fill = variable)) + geom_bar(stat = "identity") + scale_fill_manual(values=wes_palette(n=2, name="BottleRocket2")) +theme_classic() + coord_flip() + xlab("City") +
ylab("Unfunded Liability (log scale)") + ggtitle("Fig 1.b Unfunded Obligations \n (reported values)") + theme(plot.title = element_text(hjust = 0.5)) +
labs(fill = "Debt Source")
require(gridExtra)
grid.arrange(plot1, plot2, ncol=2)
require(gridExtra)
grid.arrange(plot1, plot2, nrow=2)
require(gridExtra)
grid.arrange(plot1)
View(total.reported)
ggplot(total.reported, aes(city)) + geom_bar(subset = .(variable ==
"OPEB"), aes(y = value/1000, fill =variable), stat = "identity") +
geom_bar(subset = .(variable == "Pension"),
aes(y = -(value/1000), fill = varaiable), stat = "identity")
knitr::opts_chunk$set(echo = TRUE)
# create a fake data set
## some preparation
set.seed(123)
ten_positive_rand_numbers <- abs(rnorm(10)) + 0.1
the_prob <- ten_positive_rand_numbers / sum(ten_positive_rand_numbers)
fk_data <- data.frame(job_type = sample(LETTERS[1:10], 1000,
replace = TRUE, prob = the_prob),
gender = sample(c("Male", "Female"), 1000,
replace = TRUE))
# create a fake data set
## some preparation
set.seed(123)
ten_positive_rand_numbers <- abs(rnorm(10)) + 0.1
the_prob <- ten_positive_rand_numbers / sum(ten_positive_rand_numbers)
fk_data <- data.frame(job_type = sample(LETTERS[1:10], 1000,
replace = TRUE, prob = the_prob),
gender = sample(c("Male", "Female"), 1000,
replace = TRUE))
View(fk_data)
plotting_df <-
fk_data %>%
group_by(job_type, gender) %>%
summarise(Freq = n()) %>%
# a trick!
mutate(Freq = if_else(gender == "Male", -Freq, Freq))
View(plotting_df)
## find the order
temp_df <-
plotting_df %>%
filter(gender == "Female") %>%
arrange(Freq)
View(temp_df)
the_order <- temp_df$job_type
p <-
plotting_df %>%
ggplot(aes(x = job_type, y = Freq, group = gender, fill = gender)) +
geom_bar(stat = "identity", width = 0.75) +
coord_flip() +
scale_x_discrete(limits = the_order)
p
View(plotting_df)
#Needed Libraries
library(tidyverse)
library(ggplot2)
library(wesanderson)
library(reshape2)
library(plotly)
#Data
opeb <- read.csv("OPEB_20.csv")
pension <- read_csv("PensionCalculation.csv")
#Data Processing
opeb$AAL_reported <- as.numeric(opeb$AAL_reported)
##Adding Unfunded Liability (UAAL)
opeb <- opeb %>%
mutate(UAAL_reported = AAL_reported - assets)
#Getting AAL with new discount rate
opeb <- opeb %>%
mutate(AAL_standard =  (AAL_reported*((1+disc_rate)^15) )/ (1.0403)^15)
#UAAL with new discount rate
opeb <- opeb %>%
mutate(UAAL_standard = AAL_standard - assets)
#corporate bond rate
CBR <- 0.0403
#standardized amoritization period
am_period <- 12
pension <- pension %>%
mutate(TPL = case_when(is.na(TotalPensionLiability) ~
NetLiability + Assets),
TPL_minus1 = case_when(is.na(TPL_minus1) ~
NL_minus1 + Assets),
TPL_plus1 = case_when(is.na(TPL_plus1) ~
NL_plus1 + Assets),
PercentOwed = PercentOwedTotal,
Duration = (TPL_minus1 - TPL_plus1)/
(2*TPL*.01),
Convexity = (TPL_plus1 + TPL_minus1 -
(2 * TPL))/ (2 * TPL * (0.01^2)),
Rate_Change = (CBR - DiscountRate),
Standardized_TPL =
((am_period * Rate_Change) +
(0.5 * Convexity * Rate_Change^2 * 100) +
1)*TPL,
Calc_Type =
case_when(!is.na(PerYear) ~
"Yearly Contrib",
TRUE ~ "Percentage Contrib"),
Standardized_NL = case_when(!is.na(Assets) ~ Standardized_TPL - Assets,
is.na(Assets) ~ Standardized_TPL),
reported_pension = case_when(
Calc_Type == "Yearly Contrib"
~ round(Duration,0) * PerYear,
(Calc_Type == "Percentage Contrib" & !is.na(Assets))
~ NetLiability * PercentOwed,
(Calc_Type == "Percentage Contrib" & is.na(Assets)) ~
TotalPensionLiability * PercentOwed),
standardized_pension = case_when(
Calc_Type == "Yearly Contrib"
~ am_period * PerYear,
Calc_Type == "Percentage Contrib"
~ Standardized_NL * PercentOwed))
#Summary data for OPEB
opeb.summary <- opeb %>%
group_by(city) %>%
select(UAAL_reported,UAAL_standard, revenue, Pop, city_contrib) %>%
summarise(UAAL_reported = sum(UAAL_reported),
UAAL_standard = sum(UAAL_standard),
Revenue = mean(revenue, na.rm = TRUE),
Population = mean(Pop, na.rm = TRUE),
city_contrib = sum(city_contrib, na.rm =TRUE))
#Pension Summary
pension.summary <- pension %>%
group_by(City) %>%
summarise(Pension_reported =
sum(reported_pension),
Pension_standard =
sum(standardized_pension))
#combined Pension + OPEB
Pension.UL <- c(pension.summary$Pension_reported)
total.summary <- cbind(opeb.summary, Pension.UL)
total.reported <- total.summary %>%
select(city, UAAL_reported, Pension.UL) %>%
melt(id.vars="city") %>%
mutate(variable = recode(variable,
`UAAL_reported`="OPEB",
`Pension.UL`="Pension"))
plot1 <- ggplot(total.reported, aes(x = reorder(city, value/1000), y = value/1000, fill = variable)) +
geom_bar(stat = "identity") +
scale_fill_manual(values=wes_palette(n=2, name="BottleRocket2")) +
theme_classic() + coord_flip() + xlab("City") +
ylab("Unfunded Liability (in millions)") +
ggtitle("Fig 1.a Unfunded Obligations \n (reported values in millions)") +
theme(plot.title = element_text(hjust = 0.5)) +
labs(fill = "Debt Source")+ theme(legend.position = "none")
# plot2 <- ggplot(total.reported, aes(x = reorder(city, log(value/1000)), y = log(value/1000), fill = variable)) + geom_bar(stat = "identity") + scale_fill_manual(values=wes_palette(n=2, name="BottleRocket2")) +theme_classic() + coord_flip() + xlab("City") +
#   ylab("Unfunded Liability (log scale)") + ggtitle("Fig 1.b Unfunded Obligations \n (reported values)") + theme(plot.title = element_text(hjust = 0.5)) +
#   labs(fill = "Debt Source")
require(gridExtra)
grid.arrange(plot1)
View(total.reported)
View(opeb.summary)
#Needed Libraries
library(tidyverse)
library(ggplot2)
library(wesanderson)
library(reshape2)
library(plotly)
#Data
opeb <- read.csv("OPEB_20.csv")
pension <- read_csv("PensionCalculation.csv")
#Data Processing
opeb$AAL_reported <- as.numeric(opeb$AAL_reported)
##Adding Unfunded Liability (UAAL)
opeb <- opeb %>%
mutate(UAAL_reported = AAL_reported - assets)
#Getting AAL with new discount rate
opeb <- opeb %>%
mutate(AAL_standard =  (AAL_reported*((1+disc_rate)^15) )/ (1.0403)^15)
#UAAL with new discount rate
opeb <- opeb %>%
mutate(UAAL_standard = AAL_standard - assets)
#corporate bond rate
CBR <- 0.0403
#standardized amoritization period
am_period <- 12
pension <- pension %>%
mutate(TPL = case_when(is.na(TotalPensionLiability) ~
NetLiability + Assets),
TPL_minus1 = case_when(is.na(TPL_minus1) ~
NL_minus1 + Assets),
TPL_plus1 = case_when(is.na(TPL_plus1) ~
NL_plus1 + Assets),
PercentOwed = PercentOwedTotal,
Duration = (TPL_minus1 - TPL_plus1)/
(2*TPL*.01),
Convexity = (TPL_plus1 + TPL_minus1 -
(2 * TPL))/ (2 * TPL * (0.01^2)),
Rate_Change = (CBR - DiscountRate),
Standardized_TPL =
((am_period * Rate_Change) +
(0.5 * Convexity * Rate_Change^2 * 100) +
1)*TPL,
Calc_Type =
case_when(!is.na(PerYear) ~
"Yearly Contrib",
TRUE ~ "Percentage Contrib"),
Standardized_NL = case_when(!is.na(Assets) ~ Standardized_TPL - Assets,
is.na(Assets) ~ Standardized_TPL),
reported_pension = case_when(
Calc_Type == "Yearly Contrib"
~ round(Duration,0) * PerYear,
(Calc_Type == "Percentage Contrib" & !is.na(Assets))
~ NetLiability * PercentOwed,
(Calc_Type == "Percentage Contrib" & is.na(Assets)) ~
TotalPensionLiability * PercentOwed),
standardized_pension = case_when(
Calc_Type == "Yearly Contrib"
~ am_period * PerYear,
Calc_Type == "Percentage Contrib"
~ Standardized_NL * PercentOwed))
#Summary data for OPEB
opeb.summary <- opeb %>%
group_by(city) %>%
select(UAAL_reported,UAAL_standard, revenue, Pop, city_contrib) %>%
summarise(UAAL_reported = sum(UAAL_reported),
UAAL_standard = sum(UAAL_standard),
Revenue = mean(revenue, na.rm = TRUE),
Population = mean(Pop, na.rm = TRUE),
city_contrib = sum(city_contrib, na.rm =TRUE))
View(opeb.summary)
#Pension Summary
pension.summary <- pension %>%
group_by(City) %>%
summarise(Pension_reported =
sum(reported_pension),
Pension_standard =
sum(standardized_pension))
#combined Pension + OPEB
Pension.UL <- c(pension.summary$Pension_reported)
total.summary <- cbind(opeb.summary, Pension.UL)
total.reported <- total.summary %>%
select(city, UAAL_reported, Pension.UL) %>%
melt(id.vars="city") %>%
mutate(variable = recode(variable,
`UAAL_reported`="OPEB",
`Pension.UL`="Pension"))
plot1 <- ggplot(total.reported, aes(x = reorder(city, value/1000), y = value/1000, fill = variable)) +
geom_bar(stat = "identity") +
scale_fill_manual(values=wes_palette(n=2, name="BottleRocket2")) +
theme_classic() + coord_flip() + xlab("City") +
ylab("Unfunded Liability (in millions)") +
ggtitle("Fig 1.a Unfunded Obligations \n (reported values in millions)") +
theme(plot.title = element_text(hjust = 0.5)) +
labs(fill = "Debt Source")+ theme(legend.position = "none")
# plot2 <- ggplot(total.reported, aes(x = reorder(city, log(value/1000)), y = log(value/1000), fill = variable)) + geom_bar(stat = "identity") + scale_fill_manual(values=wes_palette(n=2, name="BottleRocket2")) +theme_classic() + coord_flip() + xlab("City") +
#   ylab("Unfunded Liability (log scale)") + ggtitle("Fig 1.b Unfunded Obligations \n (reported values)") + theme(plot.title = element_text(hjust = 0.5)) +
#   labs(fill = "Debt Source")
require(gridExtra)
grid.arrange(plot1)
#Needed Libraries
library(tidyverse)
library(ggplot2)
library(wesanderson)
library(reshape2)
library(plotly)
#Data
opeb.raw <- read.csv("OPEB_20.csv")
pension.raw <- read_csv("PensionCalculation.csv")
#Needed Libraries
library(tidyverse)
library(ggplot2)
library(wesanderson)
library(reshape2)
library(plotly)
#Data
opeb.raw <- read.csv("OPEB_20.csv")
pension.raw <- read_csv("PensionCalculation.csv")
#Data Processing
opeb$AAL_reported <- as.numeric(opeb$AAL_reported)
#Needed Libraries
library(tidyverse)
library(ggplot2)
library(wesanderson)
library(reshape2)
library(plotly)
#Data
opeb.raw <- read.csv("OPEB_20.csv")
pension.raw <- read_csv("PensionCalculation.csv")
#Data Processing
opeb.raw$AAL_reported <- as.numeric(opeb.raw$AAL_reported)
##Adding Unfunded Liability (UAAL)
opeb.raw <- opeb.raw %>%
mutate(UAAL_reported = AAL_reported - assets)
#Getting AAL with new discount rate
opeb.raw <- opeb.raw %>%
mutate(AAL_standard =  (AAL_reported*((1+disc_rate)^15) )/ (1.0403)^15)
#UAAL with new discount rate
opeb.raw <- opeb.raw %>%
mutate(UAAL_standard = AAL_standard - assets)
#corporate bond rate
CBR <- 0.0403
#standardized amoritization period
am_period <- 12
pension.raw <- pension.raw %>%
mutate(TPL = case_when(is.na(TotalPensionLiability) ~
NetLiability + Assets),
TPL_minus1 = case_when(is.na(TPL_minus1) ~
NL_minus1 + Assets),
TPL_plus1 = case_when(is.na(TPL_plus1) ~
NL_plus1 + Assets),
PercentOwed = PercentOwedTotal,
Duration = (TPL_minus1 - TPL_plus1)/
(2*TPL*.01),
Convexity = (TPL_plus1 + TPL_minus1 -
(2 * TPL))/ (2 * TPL * (0.01^2)),
Rate_Change = (CBR - DiscountRate),
Standardized_TPL =
((am_period * Rate_Change) +
(0.5 * Convexity * Rate_Change^2 * 100) +
1)*TPL,
Calc_Type =
case_when(!is.na(PerYear) ~
"Yearly Contrib",
TRUE ~ "Percentage Contrib"),
Standardized_NL = case_when(!is.na(Assets) ~ Standardized_TPL - Assets,
is.na(Assets) ~ Standardized_TPL),
reported_pension = case_when(
Calc_Type == "Yearly Contrib"
~ round(Duration,0) * PerYear,
(Calc_Type == "Percentage Contrib" & !is.na(Assets))
~ NetLiability * PercentOwed,
(Calc_Type == "Percentage Contrib" & is.na(Assets)) ~
TotalPensionLiability * PercentOwed),
standardized_pension = case_when(
Calc_Type == "Yearly Contrib"
~ am_period * PerYear,
Calc_Type == "Percentage Contrib"
~ Standardized_NL * PercentOwed))
#Summary data for OPEB
opeb.summary <- opeb.raw %>%
group_by(city) %>%
select(UAAL_reported,UAAL_standard, revenue, Pop, city_contrib) %>%
summarise(UAAL_reported = sum(UAAL_reported),
UAAL_standard = sum(UAAL_standard),
Revenue = mean(revenue, na.rm = TRUE),
Population = mean(Pop, na.rm = TRUE),
city_contrib = sum(city_contrib, na.rm =TRUE))
#Pension Summary
pension.summary <- pension.raw %>%
group_by(City) %>%
summarise(Pension_reported =
sum(reported_pension),
Pension_standard =
sum(standardized_pension))
#combined Pension + OPEB
Pension.UL <- c(pension.summary$Pension_reported)
total.summary <- cbind(opeb.summary, Pension.UL)
total.reported <- total.summary %>%
select(city, UAAL_reported, Pension.UL) %>%
melt(id.vars="city") %>%
mutate(variable = recode(variable,
`UAAL_reported`="OPEB",
`Pension.UL`="Pension"))
plot1 <- ggplot(total.reported, aes(x = reorder(city, value/1000), y = value/1000, fill = variable)) +
geom_bar(stat = "identity") +
scale_fill_manual(values=wes_palette(n=2, name="BottleRocket2")) +
theme_classic() + coord_flip() + xlab("City") +
ylab("Unfunded Liability (in millions)") +
ggtitle("Fig 1.a Unfunded Obligations \n (reported values in millions)") +
theme(plot.title = element_text(hjust = 0.5)) +
labs(fill = "Debt Source")+ theme(legend.position = "none")
plot1
View(total.summary)
#Plottinf DF
total.summary %>%
select(city, UAAL_reported, UAAL_standard) %>%
melt(id.vars="city") %>%
mutate(variable = recode(variable,
`UAAL_reported`="Reported",
`UAAL_standard`="Standardized")) #%>%
#Plottinf DF
total.summary %>%
select(city, UAAL_reported, UAAL_standard) %>%
melt(id.vars="city") %>%
mutate(variable = recode(variable,
`UAAL_reported`="Reported",
`UAAL_standard`="Standardized")) %>%
mutate(value = if_else(variable == "Reported", -(value/1000), value/1000))
#Plottinf DF
the_order <- total.summary$city
total.summary %>%
select(city, UAAL_reported, UAAL_standard) %>%
melt(id.vars="city") %>%
mutate(variable = recode(variable,
`UAAL_reported`="Reported",
`UAAL_standard`="Standardized")) %>%
mutate(value = if_else(variable == "Reported", -(value/1000), value/1000)) %>%
ggplot(aes(x = city, y = value, group = variable, fill = variable)) +
geom_bar(stat = "identity") +
coord_flip() +
scale_x_discrete(limits = the_order) +
scale_fill_manual(values=wes_palette(n=2, name="BottleRocket2")) +
theme_classic() + xlab("City")
#Plottinf DF
the_order <- total.summary$city
total.summary %>%
select(city, UAAL_reported, UAAL_standard) %>%
melt(id.vars="city") %>%
mutate(variable = recode(variable,
`UAAL_reported`="Reported",
`UAAL_standard`="Standardized")) %>%
mutate(value = if_else(variable == "Reported", -(value/1000), value/1000)) %>%
ggplot(aes(x = city, y = value, group = variable, fill = variable)) +
geom_bar(stat = "identity") +
coord_flip() +
#scale_x_discrete(limits = the_order) +
scale_fill_manual(values=wes_palette(n=2, name="BottleRocket2")) +
theme_classic() + xlab("City") +
ylab("Unfunded Liability (in millions)") +
ggtitle("Fig 1. OPEB Liability ") +
theme(plot.title = element_text(hjust = 0.5)) +
labs(fill = "Valuation Type")
total.summary %>%
select(city, UAAL_reported, UAAL_standard) %>%
melt(id.vars="city") %>%
mutate(variable = recode(variable,
`UAAL_reported`="Reported",
`UAAL_standard`="Standardized")) %>%
mutate(value = if_else(variable == "Reported", -(value/1000), value/1000)) %>%
ggplot(aes(x = city, y = value, group = variable, fill = variable)) +
geom_bar(stat = "identity", width = 0.6) +
coord_flip() +
#scale_x_discrete(limits = the_order) +
scale_fill_manual(values=wes_palette(n=2, name="BottleRocket2")) +
theme_classic() + xlab("City") +
ylab("Unfunded Liability (in millions)") +
ggtitle("Fig 1. OPEB Liability ") +
theme(plot.title = element_text(hjust = 0.5)) +
labs(fill = "Valuation Type")
total.summary %>%
select(city, UAAL_reported, UAAL_standard) %>%
melt(id.vars="city") %>%
mutate(variable = recode(variable,
`UAAL_reported`="Reported",
`UAAL_standard`="Standardized")) %>%
mutate(value = if_else(variable == "Reported", -(value/1000), value/1000)) %>%
ggplot(aes(x = city, y = value, group = variable, fill = variable)) +
geom_bar(stat = "identity", width = 0.75) +
coord_flip() +
#scale_x_discrete(limits = the_order) +
scale_fill_manual(values=wes_palette(n=2, name="BottleRocket2")) +
theme_classic() + xlab("City") +
ylab("Unfunded Liability (in millions)") +
ggtitle("Fig 1. OPEB Liability ") +
theme(plot.title = element_text(hjust = 0.5)) +
labs(fill = "Valuation Type")
total.summary %>%
select(city, UAAL_reported, UAAL_standard) %>%
melt(id.vars="city") %>%
mutate(variable = recode(variable,
`UAAL_reported`="Reported",
`UAAL_standard`="Standardized")) %>%
mutate(value = if_else(variable == "Reported", -(value/1000), value/1000)) %>%
ggplot(aes(x = city, y = value, group = variable, fill = variable)) +
geom_bar(stat = "identity", width = 1.2) +
coord_flip() +
#scale_x_discrete(limits = the_order) +
scale_fill_manual(values=wes_palette(n=2, name="BottleRocket2")) +
theme_classic() + xlab("City") +
ylab("Unfunded Liability (in millions)") +
ggtitle("Fig 1. OPEB Liability ") +
theme(plot.title = element_text(hjust = 0.5)) +
labs(fill = "Valuation Type")
total.summary %>%
select(city, UAAL_reported, UAAL_standard) %>%
melt(id.vars="city") %>%
mutate(variable = recode(variable,
`UAAL_reported`="Reported",
`UAAL_standard`="Standardized")) %>%
mutate(value = if_else(variable == "Reported", -(value/1000), value/1000)) %>%
ggplot(aes(x = city, y = value, group = variable, fill = variable)) +
geom_bar(stat = "identity", width = 1) +
coord_flip() +
#scale_x_discrete(limits = the_order) +
scale_fill_manual(values=wes_palette(n=2, name="BottleRocket2")) +
theme_classic() + xlab("City") +
ylab("Unfunded Liability (in millions)") +
ggtitle("Fig 1. OPEB Liability ") +
theme(plot.title = element_text(hjust = 0.5)) +
labs(fill = "Valuation Type")
total.summary %>%
select(city, UAAL_reported, UAAL_standard) %>%
melt(id.vars="city") %>%
mutate(variable = recode(variable,
`UAAL_reported`="Reported",
`UAAL_standard`="Standardized")) %>%
mutate(value = if_else(variable == "Reported", -(value/1000), value/1000)) %>%
ggplot(aes(x = city, y = value, group = variable, fill = variable)) +
geom_bar(stat = "identity", width = .9) +
coord_flip() +
#scale_x_discrete(limits = the_order) +
scale_fill_manual(values=wes_palette(n=2, name="BottleRocket2")) +
theme_classic() + xlab("City") +
ylab("Unfunded Liability (in millions)") +
ggtitle("Fig 1. OPEB Liability ") +
theme(plot.title = element_text(hjust = 0.5)) +
labs(fill = "Valuation Type")
