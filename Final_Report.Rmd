---
title: "Benefit Threat to City Solvency - Draft"
author: "Cheikhou Kane & Faith Benamy"
date: "11/17/2019"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
#Needed Libraries
library(tidyverse)
library(ggplot2)
library(wesanderson)
library(reshape2)
library(RColorBrewer)
library(scales)

#Data
opeb.raw <- read.csv("OPEB_20_2.csv") 

pension.raw <- read_csv("PensionCalculation.csv")

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
#Data Processing for OPEB

opeb.raw$AAL_reported <- as.numeric(opeb.raw$AAL_reported)

##Adding Unfunded Liability (UAAL)
opeb.raw <- opeb.raw %>%
  mutate(UAAL_reported = AAL_reported - assets)

#Getting AAL with new discount rate
opeb.raw <- opeb.raw %>%
  mutate(AAL_standard =  (AAL_reported*((1+disc_rate)^15) )/ (1.03)^15)

#UAAL with new discount rate
opeb.raw <- opeb.raw %>%
  mutate(UAAL_standard = AAL_standard - assets)

```



```{r, echo=FALSE,message=FALSE, warning=FALSE}
#Data Processing for Pension

#corporate bond rate
CBR <- 0.04
#standardized amoritization period
am_period <- 12

pension.raw <- pension.raw %>% 
            mutate(TotalPensionLiability = case_when(
              #Replace TPL by NPL + Assets where it's missing
              is.na(TotalPensionLiability) ~ (NetLiability + Assets),
                                     TRUE ~ TotalPensionLiability
              ),
                   #Replace TPLs where they're missing
                   TPL_minus1 = case_when(is.na(TPL_minus1) ~ 
                                            (NL_minus1 + Assets),
                                          TRUE ~ TotalPensionLiability), 
                   TPL_plus1 = case_when(is.na(TPL_plus1) ~ 
                                           (NL_plus1 + Assets),
                                         TRUE ~ TotalPensionLiability),
                   PercentOwed = PercentOwedTotal, 
              #Apply Josh Raul Formula for Duration and Convexity
                   Duration = (TPL_minus1 - TPL_plus1)/
                     (2*TotalPensionLiability*.01),
                   
              Convexity = (TPL_plus1 + TPL_minus1 - 
                                (2 * TotalPensionLiability))/ (2*( TotalPensionLiability * (0.01^2))),
              
                   Rate_Change = (CBR - DiscountRate),
                   Standardized_TPL =
                     ((-am_period * Rate_Change) +
                     (0.5 * Convexity * (Rate_Change^2)) +
                       1)*TotalPensionLiability,
                   Calc_Type = 
                     case_when(!is.na(PerYear) ~ 
                              "Yearly Contrib", 
                              TRUE ~ "Percentage Contrib"),
                   Standardized_NL = case_when(!is.na(Assets) ~ Standardized_TPL - Assets,
                    is.na(Assets) ~ Standardized_TPL),
                   reported_pension = case_when(
                     Calc_Type == "Yearly Contrib" 
                     ~ round(Duration,0) * PerYear, 
                     (Calc_Type == "Percentage Contrib" & !is.na(Assets))
                     ~ NetLiability * PercentOwed, 
                   (Calc_Type == "Percentage Contrib" & is.na(Assets)) ~
                     TotalPensionLiability * PercentOwed),
                   standardized_pension = case_when(
                     Calc_Type == "Yearly Contrib" 
                     ~ am_period * PerYear, 
                     Calc_Type == "Percentage Contrib"
                     ~ Standardized_NL * PercentOwed),
                   ratio = standardized_pension/reported_pension)

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

#Summary data for OPEB
opeb.summary <- opeb.raw %>%
  group_by(city) %>%
  select(UAAL_reported,UAAL_standard, revenue, Pop, city_contrib) %>%
  summarise(UAAL_reported = sum(UAAL_reported),
            UAAL_standard = sum(UAAL_standard),
            Revenue = mean(revenue, na.rm = TRUE),
            Population = mean(Pop, na.rm = TRUE),
            city_contrib = sum(city_contrib, na.rm =TRUE))
```

```{r}
#Pension Summary

pension.summary <- pension.raw %>% 
                    group_by(City) %>% 
                    summarise(Pension_reported =
                                sum(reported_pension,na.rm = TRUE),
                              Pension_standard =
                                sum(standardized_pension,na.rm = TRUE))
```

```{r}
#combined dataframe with Pension + OPEB data
Pension.UL <- cbind(Pen_reported = pension.summary$Pension_reported, 
                    Pen_standard = pension.summary$Pension_standard)

total.summary <- cbind(opeb.summary, Pension.UL)

#Adding Total Lialbility
total.summary <- total.summary %>%
  mutate(total_reported = UAAL_reported + Pen_reported,
         total_standard = UAAL_standard + Pen_standard)

#Adding Per capita Calculation

total.summary$Revenue[!is.finite(total.summary$Revenue)] <- NA  #Clean out Revenue 
total.summary$Population[!is.finite(total.summary$Population)] <- NA #Clean out Population

total.summary <- total.summary %>%
  mutate(total_reported.capita = total_reported/Population,
         total_standard.capita = total_standard/Population)

total.summary <- total.summary %>%
  mutate(UAAL_reported.capita = UAAL_reported/Population,
         UAAL_standard.capita = UAAL_standard/Population)

total.summary <- total.summary %>%
  mutate(Pen_reported.capita = Pen_reported/Population,
         Pen_standard.capita = Pen_standard/Population)

#Adding share revenue

total.summary <- total.summary %>%
  mutate(OPEB.share = round(100*(city_contrib/Revenue),2))
```

# Introduction

The unfunded obligations of the pension and Other Post-Employment Benefits (OPEB) plans sponsored by local governments in the United States continue to grow. In the following report, we study in detail these financial obligations of the 20 largest US cities ( by population ). We review both their own reports on these obligations and how these differ from our estimates based on more realistic assumptions.

We find that most cities reported OPEB liabilities close to our measures, however, for pensions, we find that cities drastically undervalue their unfunded liabilities. In fact, at the end of the 2017 fiscal year, the 20 largest U.S cities reported unfunded liabilities of over **\$255.4**  billion: **\$142.2** billion for pensions and **$113.2** billion for OPEB. According to our calculations, we estimate the true unfunded liabilities to be almost **\$453.8** billion: **\$323.1** billion for pensions and **\$130.7** billion for OPEB.

The largest discrepancy between the unfunded pension liabilities reported by the cities and our estimates of their pension liabilities is primarily the result of different discount rates used in valuing these liabilities. Under government accounting standards, cities are given broad discretion to choose a discount rate based on their expectation of future returns on plan assets. Several cities chose discount rates for their pension plans at 7% or higher. But discount rates are supposed to represent a conservative rate of return with a high degree of confidence. For example, the FASB stipulates that corporations must use the AA corporate bond rate as the discount rate for their pension plans. In June, 2017, the AA corporate bond rate for 15 years was approximately 4%. Therefore, we used that 4% as the discount rate in our estimates of the unfunded liabilities for pensions and OPEB in all 20 cities. 

Our analysis is divided into three main parts. First, we present in detail the unfunded pension liability of the  20 cities, followed by pension liability per capita and pension liability as a percentage of revenues.  Second, we present in detail the unfunded OPEB liability of the 20 cities, followed by OPEB liability per capital and OPEB liability as a percentage of revenues. Third, we present total pension and OPEB liabilities for each city, followed by total liabilities per capita and total liabilities as a percentage of revenues. 

# I. Pension Liability

In this section, we study in detail the pension liability of the 20 cities. We report on both their own measurements of their pension obligations, and how these differ from valuations using a standardized measure.
First, we present the total unfunded pension liability in dollar terms. Finally, we showcase the total liability scaled by population size.

### 1. Unfunded Pension Liability

The difference in the reported pension liability and the ones calculated under our standardized valuation are illustrated in Figure 1 below. It appears that cities report much lower unfunded liabilities. For almost all cities, the standardized pension liability is greater than the reported value. Fort Worth, Philadelphia, San Diego and San Jose are the only cities that reported an unfunded pension liability lower than our standardized measure. Once again, we can see the sensitivity of the unfunded liabilities to the discount rate. 

```{r, warning=FALSE, message=FALSE}
total.summary %>%
  select(city, Pen_reported, Pen_standard) %>%
  melt(id.vars="city") %>%
  mutate(variable = recode(variable,
                           `Pen_reported`="Reported",
                           `Pen_standard`="Standardized")) %>%
  ggplot(aes(x = city, y = value/1000, group = variable, fill = variable)) +
  geom_bar(stat = "identity",position = "dodge", width = .9) +
  
  #Add Outlier Textbox: New York 
  #annotate("label", x = 18, y = 200000, label = "NOT DRAWN TO SCALE \n Standardized: $726,590", size=3) +
  #annotate("segment", x = 17, xend = 16, y = 200000, yend = 200000, colour = "black", arrow=arrow(length = unit(0.2, "cm")), size= 0.1) +
  
  #Zoom into graph
 #coord_flip(ylim = c(0,400000)) +
  coord_flip() +
  scale_fill_manual(values= c(wes_palette(n=1, name="Royal1"),"#F98400")) +
  scale_y_continuous(labels = dollar)+
  theme_classic() + xlab("City") + 
  ylab("Unfunded Liability (in millions)") + 
  ggtitle("Fig 1. Pension Liability ") +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(fill = "Valuation Type")
  
```

Compared to OPEB, the difference between the reported values and our valuations is more pronounced for pension. 

### 2. Unfunded Pension Liability Per Capita

The difference in the reported pension liability and our own valuations scaled by population size are illustrated in Figure 2 below. Similar to OPEB, we provide per capita measures to present city residents with a better idea of their city's pension financial burden and how it compares with that of other cities. The average reported unfunded pension liability per capita was \$`r round(mean(total.summary$Pen_reported.capita,na.rm=TRUE),1)*1000` while the average standardized unfunded pension liability per capita was \$41,800.

```{r, warning=FALSE, message=FALSE}
total.summary %>%
  select(city, Pen_reported.capita, Pen_standard.capita) %>%
  melt(id.vars="city") %>%
  mutate(variable = recode(variable,
                           `Pen_reported.capita`="Reported",
                           `Pen_standard.capita`="Standardized")) %>%
  ggplot(aes(x = city, y = value*1000, group = variable, fill = variable)) +
  geom_bar(stat = "identity",position = "dodge", width = .9) +
  
   #Add Outlier Textbox: San Francisco
  annotate("label", x = 18, y = 75000, label = "NOT DRAWN TO SCALE \n Standardized: $193,260", size=3) +
  annotate("segment", x = 19, xend = 20, y = 75000, yend = 75000, colour = "black", arrow=arrow(length = unit(0.2, "cm")), size= 0.1) +
  
  #Zoom into graph
  coord_flip(ylim = c(0,100000)) +
  scale_fill_manual(values= c(wes_palette(n=1, name="Royal1"),"#F98400")) +
  scale_y_continuous(labels=dollar)+
  theme_classic() + xlab("City") + 
  ylab("Unfunded Liability per capita") + 
  ggtitle("Fig 2. Pension Liability per capita ") +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(fill = "Valuation Type")
```

While New York has the largest unfunded pension liability in terms of total dollar amount, the City of San Francisco has the largest one, about $193,000 in terms of dollars per capita.

# II. OPEB Liability

In this section, we study in detail the OPEB liability of the 20 cities. We report on both their own measurements of their OPEB obligations, and how these differ from valuations using a standardized measure. In addition, we provide several ways of comparing the financial burden due to OPEB. 
First, we present the total Unfunded Actuarial Accrued Liability (UAAL),i.e the difference between the present value of benefit payment (current and past) and the present value of the OPEB Asset Fund. Second, we showcase the total UAAL scaled by population size. Finally, we present the share of city's revenue utilized to cover OPEB benefit payments.  

### 1. Unfunded OPEB Liability

The difference in the reported UAALs and the ones calculated under our standardized valuation are illustrated in Figure 3 below. It appears that cities report lower unfunded liabilities. For almost all cities, the standardized UAAL is greater than the reported value. Only Chicago, Indianapolis, New York and Seattle reported a UAAL lower than our standardized measure. This makes sense, because as we explained earlier, the higher the discount rate, the lower the unfunded liability and as illustrated in our appendix most cities use a discount rate higher than our standardized one.

```{r, warning=FALSE, message=FALSE}
total.summary$city <- as.factor(total.summary$city)
total.summary %>%
  #filter(city != "Denver") %>%
  #filter(city != "Columbus") %>%
  select(city, UAAL_reported, UAAL_standard) %>%
  melt(id.vars="city") %>%
  mutate(variable = recode(variable,
                           `UAAL_reported`="Reported",
                           `UAAL_standard`="Standardized")) %>%
  ggplot(aes(x = city, y = value/1000, group = variable, fill = variable)) +
  geom_bar(stat = "identity", position="dodge",width = .9) +
  
  #Add Outlier Textbox: New York 
  annotate("label", x = 18, y = 7200, label = "NOT DRAWN TO SCALE \n Reported: $88,400 - Standardized: $77,880", size=3) +
  annotate("segment", x = 17, xend = 16, y = 7300, yend = 7300, colour = "black", arrow=arrow(length = unit(0.2, "cm")), size= 0.1) +
  
  #Zoom Into graph
  coord_flip(ylim = c(0,10000)) +
  scale_fill_manual(values= c(wes_palette(n=1, name="Royal1"),"#F98400")) +
  scale_y_continuous(labels=dollar)+
  theme_classic() + xlab("City") + 
  ylab("Unfunded Liability (in millions)") + 
  ggtitle("Fig 3. OPEB Liability ") +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(fill = "Valuation Type")
```

It is interesting to note that cities with the largest populations such as New York, Los Angeles, Boston or San Francisco carry the highest amounts of debt. But would this be different, if we looked at the unfunded liability not in terms of total dollars amount, but in terms of dollars per capita.

### 2. Unfunded OPEB Liability Per Capita

The difference in the reported UAALs and our own valuations scaled by population size are illustrated in Figure 4 below. We provide per capita measures to present city residents a better idea of their city's OPEB financial burden and how it compares with that of other cities.


```{r, warning=FALSE, message=FALSE}

total.summary %>%
  filter(city != "Columbus") %>%
  select(city, UAAL_reported.capita, UAAL_standard.capita) %>%
  melt(id.vars="city") %>%
  mutate(variable = recode(variable,
                           `UAAL_reported.capita`="Reported",
                           `UAAL_standard.capita`="Standardized")) %>%
  #mutate(value = if_else(variable == "Reported", -(value), value)) %>%
  ggplot(aes(x = city, y = value*1000, group = variable, fill = variable)) +
  geom_bar(stat = "identity", position = "dodge",width = .9) +
  
  coord_flip() +
  scale_fill_manual(values= c(wes_palette(n=1, name="Royal1"),"#F98400")) +
  scale_y_continuous(labels=dollar)+
  theme_classic() + xlab("City") + 
  ylab("Unfunded Liability per capita") + 
  ggtitle("Fig 4. OPEB Liability per capita ") +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(fill = "Valuation Type")
```


### 3. Share of revenue

The share or proportion of a city's revenues used to pay for benefit payments in 2017 is illustrated in Figure 5. This further provides users with another alternative to compare cities regarding their OPEB financial burden. The average share of revenue was **2.95%** with a low of **0.16%** for Denver and a high of **7.2%** for Los Angeles. It is interesting to note that the city of New York fares much better under this metric than the previous ones. 

```{r, warning=FALSE, message=FALSE}

total.summary %>%
  ggplot(aes(x = city, y = OPEB.share/100)) + geom_bar(stat = "identity",fill = "#F98400") +
  scale_y_continuous(labels = scales::percent) +
  theme_classic() + coord_flip() +
  xlab("City") + ylab("Share of Revenue") + 
  ggtitle("Fig 5. OPEB Benefit Payment as share of 2017 Revenue \n (reported values)") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(fill = "Revenue Share (%)")
```


# III. Total Unfunded Liability

In this section, we combine our results from the two previous sections to study in detail the total unfunded liability of the 20 cities. We report on both their own measurements of their total obligations, and how these differ from valuations using a standardized measure.
Similar to pension, first, we present the total unfunded liability in dollar terms. Finally, we showcase the total liability scaled by population size.

### 1. Total Unfunded Liability

The difference in the reported total liabilty, i.e pension and OPEB combined, and the ones calculated under our standardized valuation are illustrated in Figure 6 below. In accordance with our results from the previous two sections, we find that cities tend to report lower unfunded liabilities. For almost all cities, the standardized total liability is greater than the reported value. The average reported total liability was a little over  **$12 billion** while the average standardized total liability was a little less than **$95 billion**. Only three cities out of the 20: Philadelphia, San Diego and San Jose reported an unfunded total liability lower than our standardized measure. Once again, we can see the sensitivity of the unfunded liabilities to the discount rate. 

```{r}
total.summary %>%
  select(city, total_reported, total_standard) %>%
  melt(id.vars="city") %>%
  mutate(variable = recode(variable,
                           `total_reported`="Reported",
                           `total_standard`="Standardized")) %>%
  ggplot(aes(x = city, y = value/1000, group = variable, fill = variable)) +
  geom_bar(stat = "identity",position="dodge") +
  
   #Add Outlier Textbox: New York 
  annotate("label", x = 18, y = 200000, label = "NOT DRAWN TO SCALE \n Standardized: $804,000", size=3) +
  annotate("segment", x = 17, xend = 16, y = 200000, yend = 200000, colour = "black", arrow=arrow(length = unit(0.2, "cm")), size= 0.1) +
  
  #Zoom into graph
  coord_flip(ylim = c(0,400000)) +
  scale_y_continuous(labels=dollar)+
  scale_fill_manual(values= c(wes_palette(n=1, name="Royal1"),"#F98400")) +
  theme_classic() + xlab("City") + 
  ylab("Unfunded Liability (in millions)") + 
  ggtitle("Fig 6. Total Liability ") +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(fill = "Valuation Type")
```



### 2. Total Unfunded Liability Per Capita

Similar to OPEB and pension, we also provide in Figure 7 below the total liability per capita for all the cities included in our report. As one would expect, the total unfunded liabilities these cities reported were usually lower than our standardized measures. The average reported total liability per capita was **$4,500** while the average standardized total liability per capita was **$44,800**. 

```{r, warning=FALSE, message=FALSE}
total.summary %>%
  select(city, total_reported.capita, total_standard.capita) %>%
  melt(id.vars="city") %>%
  mutate(variable = recode(variable,
                           `total_reported.capita`="Reported",
                           `total_standard.capita`="Standardized")) %>%
  ggplot(aes(x = city, y = value*1000, group = variable, fill = variable)) +
  geom_bar(stat = "identity",position = "dodge", width = .9) +
  
  #Add Outlier Textbox: san Francisco 
  annotate("label", x = 18, y = 75000, label = "NOT DRAWN TO SCALE \n Standardized: $198,000", size=3) +
  annotate("segment", x = 19, xend = 20, y = 75000, yend = 75000, colour = "black", arrow=arrow(length = unit(0.2, "cm")), size= 0.1) +
  
  #Zoom into graph
  coord_flip(ylim = c(0,100000)) +
  scale_fill_manual(values= c(wes_palette(n=1, name="Royal1"),"#F98400")) +
  scale_y_continuous(labels = dollar) +
  theme_classic() + xlab("City") + 
  ylab("Unfunded Liability per capita") + 
  ggtitle("Fig 7. Total Liability per capita ") +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(fill = "Valuation Type")
```


# Conclusion

In this report, we have investigated in detail the financial obligations the 20 largest US cities (by population) using both their own measurements of their obligations and valuations using more realistic assumptions. In particular, we have focused on using a discount rate that satisfies governmental accounting standards. In order to place cities on a more comparable footing, we decided to use the **15 year AA corporate bond rate** (June 2017), approximately **4.00%**, as the discount rate for both pension and OPEB for all plans sponsored by the 20 cities. One key finding is that cities drastically undervalue their pensions obligations. In fact, the 20 cities reported \$142.2 billion in unfunded liability; however, according to our calculations, we find that the unfunded pension liability for these cities is \$1.88 trillion. For OPEB, the 20 largest US cities reported unfunded liabilities close to our valuations. In fact, the total reported unfunded OPEBliability (\$113.2 billion) was actually higher than our measure (\$111.4 billion). 

## Appendix A: Overview of Liability Issues

The unfunded obligations of local governments with regard to pension and OPEB plans are sensitive to underlying actuarial assumptions, and even small changes can significantly change reported liabilities. Two notable assumptions are the discount rate and the definition of a city. 

### 1. Discount Rates

In 2004, new reporting guidelines from the Governmental Accounting Standards Board (GASB) were released. These guidelines, which became effective in 2007, required cities to report for the cost of both OPEB and Pension plans on an accrual basis. In particular, GASB Statement No. 45, Accounting and Financial Reporting by Employers for Postemployment Benefits Other Than Pensions, represented a significant change towards accrual reporting for governmental entities.

Although GASB 45 was a major shift in governmental accounting and financial reporting, it still provides an incentive for governments to use a higher rate to discount future benefit promises if they set up a trust and commit to paying the Annual Required Contribution (ARC). The ARC is the minimum amount required to cover both the plan's normal costs (the Present Value of benefit payments for the current year) and the unfunded liability (the gap between current assets and the present value of future benefits already promised to employees) amortized over a  specific period. Thus, it becomes clear that the discount rate plays a pivotal role in assessing the ARC. In fact, the higher the discount rate, the lower the ARC, and vice versa.
In other words, with a trust and a commitment to paying the ARC, cities can discount obligations by their own estimate of the expected long-term return of their assets. This idiosyncracy makes it problematic to compare cities according to their own reports. In fact, for OPEB alone, discount rates for the plans sponsored by the cities in our report ranged from **2.92%** to **7.95%** as displayed below in Figure 8. 

```{r}
opeb.raw %>%
  select(city, disc_rate) %>%
  ggplot( aes(x=disc_rate)) +
  geom_histogram(fill= "#F98400", color="black")+
  geom_vline(aes(xintercept=mean(disc_rate, na.rm = TRUE)), color="black",
             linetype="dashed")+
  annotate("label", x = 0.053, y=4, label = "Average Discount Rate: 5.2%") +
  scale_x_continuous(labels = scales::percent) +
  labs(title="Fig 1. Reported Discount Rates \n (2017)",x="Discount Rate", y = "Count")+
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5))
```

As FASB stipulates that local governments must use a high-quality municipal bond rate as the discount rate, we decided to use the 15 year AA corporate bond rate (June 2017), approximately **4.00%**, as the discount rate for both pension and OPEB for all cities in our valuations in order to place cities on a more comparable footing. It is however important to note that any value for the discount rate still remains an assumption on the expected returns of the assets of city plans.  

In addition to this report, we have created an interactive website that enables users to explore the data we collected and compare cities using their own discount rate as well as their own amortization period. 

### 2. City Definition

Another issue that arise in assessing the financial obligation of local governments lies in the complexity of defining the scope of a city. In fact, employees of a given city may be enrolled in a plan sponsored either by either the city itself, the state, the county or a combination of these. It then becomes difficult in some cases to compare the obligations of different cities as they might have different scopes.