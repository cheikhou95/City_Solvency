---
title: "Financial Wellness"
output:
  pdf_document: default
  html_document:
    number_sections: yes
date: "9/18/2019"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
#Needed Libraries
library(tidyverse)
library(ggplot2)
library(wesanderson)
library(reshape2)
library(plotly)

#Data
opeb <- read.csv("OPEB - Sheet1.csv") %>%
  filter(city != "Philadelphia")
pension <- read_csv("PensionCalculation.csv")

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
#Data Processing

opeb$AAL_reported <- as.numeric(opeb$AAL_reported)

##Adding Unfunded Liability (UAAL)
opeb <- opeb %>%
  mutate(UAAL_reported = AAL_reported - assets)

#Getting AAL with new discount rate
opeb <- opeb %>%
  mutate(AAL_standard =  (AAL_reported*((1+disc_rate)^15) )/ (1.0403)^15)

#UAAL with new discount rate
opeb <- opeb %>%
  mutate(UAAL_standard = AAL_standard - assets)

#corporate bond rate
CBR <- 0.0403
#standardized amoritization period
am_period <- 12

pension <- pension %>% 
            mutate(TPL = case_when(is.na(TotalPensionLiability) ~ 
                                     NetLiability + Assets),
                   TPL_minus1 = case_when(is.na(TPL_minus1) ~ 
                                            NL_minus1 + Assets), 
                   TPL_plus1 = case_when(is.na(TPL_plus1) ~ 
                                           NL_plus1 + Assets),
                   PercentOwed = PercentOwedTotal, 
                   Duration = (TPL_minus1 - TPL_plus1)/
                     (2*TPL*.01),
                   Convexity = (TPL_plus1 + TPL_minus1 - 
                                (2 * TPL))/ (2 * TPL * (0.01^2)),
                   Rate_Change = (CBR - DiscountRate),
                   Standardized_TPL =
                     ((am_period * Rate_Change) +
                     (0.5 * Convexity * Rate_Change^2 * 100) +
                       1)*TPL,
                   Calc_Type = 
                     case_when(!is.na(PerYear) ~ 
                              "Yearly Contrib", 
                              TRUE ~ "Percentage Contrib"),
                   Standardized_NL = case_when(!is.na(Assets) ~ Standardized_TPL - Assets,
                    is.na(Assets) ~ Standardized_TPL),
                   reported_pension = case_when(
                     Calc_Type == "Yearly Contrib" 
                     ~ round(Duration,0) * PerYear, 
                     (Calc_Type == "Percentage Contrib" & !is.na(Assets))
                     ~ NetLiability * PercentOwed, 
                   (Calc_Type == "Percentage Contrib" & is.na(Assets)) ~
                     TotalPensionLiability * PercentOwed),
                   standardized_pension = case_when(
                     Calc_Type == "Yearly Contrib" 
                     ~ am_period * PerYear, 
                     Calc_Type == "Percentage Contrib"
                     ~ Standardized_NL * PercentOwed))

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

cities <- c("Boston", "Jacksonville", "Los Angeles", "Minneapolis", "New York")

#Summary data for OPEB
opeb.summary <- opeb %>%
  group_by(city) %>%
  select(UAAL_reported,UAAL_standard, revenue, Population, city_contrib) %>%
  summarise(UAAL_reported = sum(UAAL_reported),
            UAAL_standard = sum(UAAL_standard),
            Revenue = mean(revenue, na.rm = TRUE),
            Population = mean(Population, na.rm = TRUE),
            city_contrib = sum(city_contrib, na.rm =TRUE))

pension.summary <- pension %>% 
                    filter(City %in% cities, City != "Boston") %>% 
                    group_by(City) %>% 
                    summarise(Pension_reported =
                                sum(reported_pension),
                              Pension_standard =
                                sum(standardized_pension))

Pension.UL <- c(0, pension.summary$Pension_reported)

opeb.summary <- cbind(opeb.summary, Pension.UL)
```


The unfunded obligations of the pension and Other Post-Employment Benefits (OPEB) plans sponsored by local governments in the United States continue to grow. In the following report, we study in detail the financial obligations of 5 major US cities: Boston, Jacksonville, Los Angeles, Minneapolis and New York. We report on both their own measurements of their obligations, and how these differ from valuations using more realistic assumptions.

At the end of the 2017 fiscal year, the following cities reported unfunded liabilities of over 112 billions USD:  16.3 billions for pensions, $96 billions for OPEB. 

**I. Rankings**

In the following section, we showcase different ways of ranking cities with respect to their financial obligations. First, we compare them using reported values then using values calculated with more realistic assumptions. 

**1. Reported Value Rankings**

Using reported values, we rank cities according to: the grand total of their financial obligations, the share of revenue used for benefit payments (OPEB only), and finally the financial obligation scaled by population size.  

**Financial Obligations Grand Total**

```{r, echo=FALSE}
liability.summary <- opeb.summary %>%
  select(city, UAAL_reported, Pension.UL) %>%
  melt(id.vars="city") %>%
  mutate(variable = recode(variable,
                           `UAAL_reported`="OPEB",
                           `Pension.UL`="Pension"))
```


```{r, echo=FALSE, message=FALSE, warning=FALSE}

plot1 <- ggplot(liability.summary, aes(x = reorder(city, value/1000), y = value/1000, fill = variable)) + geom_bar(stat = "identity") + scale_fill_manual(values=wes_palette(n=2, name="BottleRocket2")) +theme_classic() + coord_flip() + xlab("City") + 
  ylab("Unfunded Liability (in millions)") + ggtitle("Fig 1.a Unfunded Obligations \n (reported values in millions)") + theme(plot.title = element_text(hjust = 0.5)) +
  labs(fill = "Debt Source")+ theme(legend.position = "none")

plot2 <- ggplot(liability.summary, aes(x = reorder(city, log(value/1000)), y = log(value/1000), fill = variable)) + geom_bar(stat = "identity") + scale_fill_manual(values=wes_palette(n=2, name="BottleRocket2")) +theme_classic() + coord_flip() + xlab("City") + 
  ylab("Unfunded Liability (log scale)") + ggtitle("Fig 1.b Unfunded Obligations \n (reported values)") + theme(plot.title = element_text(hjust = 0.5)) +
  labs(fill = "Debt Source") 

```

Given the skewness of the data, we decided to present the reported total of the unfunded obligations using a logarithmic scale as well. 

```{r, echo=FALSE, message=FALSE, warning=FALSE}

require(gridExtra)
grid.arrange(plot1, plot2, ncol=2)

```


**OPEB benefit payment as share of revenue**

```{r, echo=FALSE, message=FALSE, warning=FALSE}

opeb.summary %>%
  mutate(share_revenue = round(100*(city_contrib/Revenue),2)) %>%
  ggplot(aes(x = reorder(city, share_revenue), y = share_revenue, fill = city)) + geom_bar(stat = "identity") + scale_fill_manual(values=wes_palette(n=5, name="BottleRocket2")) +theme_classic() + coord_flip() + xlab("City") + 
  ylab("Share of Revenue") + ggtitle("Fig 2. OPEB Benefit Payment as share of Revenue \n (2017 reported values)") + theme(plot.title = element_text(hjust = 0.5))

```


**Total Obligation per capita**

```{r}
liability.capita <- opeb.summary %>%
  select(city, Population, UAAL_reported, Pension.UL) %>%
  transmute(city = city,
            OPEB.capita = UAAL_reported/Population,
            Pension.capita = Pension.UL/Population) %>%
  melt(id.vars="city") %>%
  mutate(variable = recode(variable,
                           `OPEB.capita`="OPEB",
                           `Pension.capita`="Pension"))

ggplot(liability.capita, aes(x = reorder(city, value), y = value, fill = variable)) + geom_bar(stat = "identity") + scale_fill_manual(values=wes_palette(n=2, name="BottleRocket2")) +theme_classic() + coord_flip() + xlab("City") + 
  ylab("Unfunded Liability (in thousands)") + ggtitle("Fig 3. Unfunded Obligations per capita \n (reported values)") + theme(plot.title = element_text(hjust = 0.5)) +
  labs(fill = "Debt Source")

```


**2. Calculated Values Rankings**

Using calculated values, we rank cities according to the grand total of their financial obligations and the financial obligation scaled by population size. 
For OPEB, we calculate the Unfunded actuarial liability of each city with the AA corporate rate (4.03%) as the discount rate and a 15 year amortization period. 

```{r, echo=FALSE, message=FALSE, warning=FALSE}

ggplot(opeb.summary,aes(x = reorder(city, log(UAAL_standard)), y = log(UAAL_standard), fill = city)) + geom_bar(stat = "identity") +
scale_fill_manual(values=wes_palette(n=5, name="BottleRocket2")) +theme_classic() + coord_flip() +
  xlab("City") + ylab("Unfunded OPEB Liability (log scale)") + ggtitle("Unfunded OPEB Liability \n (calculated values)") + theme(plot.title = element_text(hjust = 0.5))

```

**Obligations per capita**

```{r, echo=FALSE, message=FALSE, warning=FALSE}
opeb.summary %>%
  mutate(UAAL_capita_std = UAAL_standard/Population) %>%
  ggplot(aes(x = reorder(city, UAAL_capita_std), y = UAAL_capita_std, fill = city)) + geom_bar(stat = "identity") +
scale_fill_manual(values=wes_palette(n=5, name="BottleRocket2")) +theme_classic() + coord_flip() +
  xlab("City") + ylab("Unfunded OPEB Liability (in thousands)") + ggtitle("Unfunded OPEB Liability per capita \n (calculated values)") + theme(plot.title = element_text(hjust = 0.5))
```

For Pensions, we also used the corporate discount rate of 4.03 but used a 12 year amoritizaion period (which is the unweighted average of all pension plans). 

```{r, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(pension.summary,aes(x = reorder(City, log(Pension_standard)), y = log(Pension_standard), fill = City)) + geom_bar(stat = "identity") +
scale_fill_manual(values=wes_palette(n=5, name="BottleRocket2")) +theme_classic() + coord_flip() +
  xlab("City") + ylab("Unfunded Pension Liability (log scale)") + ggtitle("Unfunded Pension Liability \n (calculated values)") + theme(plot.title = element_text(hjust = 0.5))
```


**II. Case Study: Los Angeles**


```{r, echo=FALSE, message=FALSE, warning=FALSE}
#Getting funded ratios
opeb <- opeb %>%
  mutate(funded_ratio_standard = 100*(assets/AAL_standard))

df1 <- opeb %>%
  filter(city == "Los Angeles") %>%
  select(entity,funded_ratio_reported,funded_ratio_standard)

entity.abbrev <- c("City", "LACERS", "DWP")

df1 <- cbind(df1,entity.abbrev)

df2 <- df1 %>%
  select(entity.abbrev, funded_ratio_reported, funded_ratio_standard) %>%
  melt(id.vars='entity.abbrev') %>%
  mutate(variable = recode(variable,
                           `funded_ratio_reported`="Reported",
                           `funded_ratio_standard`="Calculated"))


ggplot(df2, aes(x=entity.abbrev, y=value, fill=variable)) + geom_bar(stat='identity', position='dodge') + scale_fill_manual(values=wes_palette(n=2, name="BottleRocket2")) +
  xlab("Entity") + ylab("OPEB Funded Ratio") + theme_classic()  + ggtitle("City of Los Angeles OPEB Funded Ratios") + theme(plot.title = element_text(hjust = 0.5)) + labs(fill = "Type")
```



##All Cities

```{r}
all_cities <- pension %>% 
                    filter(!(City %in% c("Boston", "Seattle"))) %>%
                    group_by(City) %>% 
                    summarise(Pension_reported =
                                sum(reported_pension),
                              Pension_standard =
                                sum(standardized_pension)) %>% 
                    arrange(desc(City)) %>% 
                    mutate(City = fct_inorder(City))

ggplot(all_cities, aes(x = City, y = Pension_reported)) + geom_bar(stat = "identity", fill = wes_palette("BottleRocket1")[1]) + coord_flip() + theme_classic()+
  xlab("City") + ylab("Reported Net Pension Liability For All Cities") + ggtitle("Reported Net Pension Liability") + theme(plot.title = element_text(hjust = 0.5))


ggplot(all_cities, aes(x = City, y = log(Pension_reported))) + geom_bar(stat = "identity", fill = wes_palette("BottleRocket1")[1]) + coord_flip() + theme_classic()+
  xlab("City") + ylab("Reported Net Pension Liability For All Cities (Log)") + ggtitle("Reported Net Pension Liability (Log)") + theme(plot.title = element_text(hjust = 0.5))


```
